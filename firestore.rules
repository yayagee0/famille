rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isFamily() {
      return request.auth != null &&
        request.auth.token.email in [
          "nilezat@gmail.com",
          "abdessamia.mariem@gmail.com",
          "yazidgeemail@gmail.com",
          "yahyageemail@gmail.com"
        ];
    }

    // Posts collection
    match /posts/{postId} {
      // All family can create, read, update
      allow read, create, update: if isFamily();
      
      // Only the post owner can delete
      allow delete: if isFamily() &&
        resource.data.authorUid == request.auth.uid;
    }

    // Smart Engine Collections
    
    // Identity traits - users can only access their own
    match /identity_traits/{userId} {
      allow read, write: if isFamily() && userId == request.auth.uid;
    }

    // Islamic identity - users can only access their own
    match /islamic_identity/{userId} {
      allow read, write: if isFamily() && userId == request.auth.uid;
    }

    // User-specific nudges, badges, feedback
    match /users/{userId}/{collection}/{docId} {
      allow read, write: if isFamily() && userId == request.auth.uid;
    }

    // Daily polls - all family can read and vote
    match /daily_polls/{pollId} {
      allow read: if isFamily();
      allow create: if isFamily();
      allow update: if isFamily() && 
        request.resource.data.keys().hasOnly(['votes', 'isClosed', 'resultsPosted']);
    }

    // Analytics - system-generated, family can read
    match /analytics/{date} {
      allow read: if isFamily();
      allow write: if isFamily(); // For system operations
    }

    // Seasonal banners - read-only for family
    match /seasonal/{docId} {
      allow read: if isFamily();
    }

    // Notifications collection - users can only access their own notifications
    match /notifications/{userId}/items/{notificationId} {
      // Users can only read and update their own notifications
      allow read, write: if isFamily() && userId == request.auth.uid;
    }

    // Daily mood entries - users can only write/update their own entries
    match /daily-moods/{dateId}/entries/{uid} {
      // All family can read mood entries
      allow read: if isFamily();
      
      // Users can only write/update their own mood entry
      allow write, update: if isFamily() && 
        uid == request.auth.uid &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.email == request.auth.token.email;
    }

    // Daily polls - all family can read and vote
    match /daily_polls/{pollId} {
      allow read: if isFamily();
      allow create: if isFamily();
      allow update: if isFamily() && 
        request.resource.data.keys().hasOnly(['votes', 'isClosed', 'resultsPosted']);
    }

    // Everything else (users, families, etc.)
    match /{doc=**} {
      allow read, write: if isFamily();
    }
  }
}
